<script type="text/html" data-template-name="multiSensor">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]text.name">
    </div>

    <div class="form-row">
        <label for="node-input-idField" data-i18n="label.id"></label>
        <input type="text" id="node-input-idField" style="width:70%">
        <input type="hidden" id="node-input-idType">
    </div>
    
    <div class="form-row">
        <label for="node-input-inputValue" data-i18n="label.input"></label>
        <input type="text" id="node-input-inputValue" style="width:70%">
        <input type="hidden" id="node-input-inputType">
    </div>

    <div class="form-row">
        <label for="node-input-activeValue" data-i18n="label.onActive"></label>
        <input type="text" id="node-input-activeValue" style="width:70%">
        <input type="hidden" id="node-input-activeType">
    </div>

    <div class="form-row">
        <label for="node-input-inactiveValue" data-i18n="label.onInactive"></label>
        <input type="text" id="node-input-inactiveValue" style="width:70%">
        <input type="hidden" id="node-input-inactiveType">
    </div>
    
    <div class="form-row">
        <label for="node-input-sendOnActive" data-i18n="label.sendOnActive"></label>
        <input type="text" id="node-input-sendOnActive" style="width:70%">
        <input type="hidden" id="node-input-sendOnActiveType">
    </div>
    
    <div class="form-row">
        <label for="node-input-sendOnInactive" data-i18n="label.sendOnInactive"></label>
        <input type="text" id="node-input-sendOnInactive" style="width:70%">
        <input type="hidden" id="node-input-sendOnInactiveType">
    </div>
    
    <div class="form-row">
        <label for="node-input-sendOnTimeout" data-i18n="label.sendOnTimeout"></label>
        <input type="text" id="node-input-sendOnTimeout" style="width:70%">
        <input type="hidden" id="node-input-sendOnTimeoutType">
    </div>
    
    <div class="form-row">
        <label for="node-input-activateDelay"><i class="fa fa-clock-o"></i> <span data-i18n="label.activeDelay"></span></label>
        <input type="text" id="node-input-activateDelay" style="text-align:end; width:50px !important">
        <select id="node-input-activateDelayUnit" style="width:170px !important">
            <option value="milliseconds" data-i18n="label.time.ms"></option>
            <option value="seconds" data-i18n="label.time.s"></option>
            <option value="minutes" data-i18n="label.time.m"></option>
            <option value="hours" data-i18n="label.time.h"></option>
            <option value="days" data-i18n="label.time.d"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-inactivateDelay"><i class="fa fa-clock-o"></i> <span data-i18n="label.inactiveDelay"></span></label>
        <input type="text" id="node-input-inactivateDelay" style="text-align:end; width:50px !important">
        <select id="node-input-inactivateDelayUnit" style="width:170px !important">
            <option value="milliseconds" data-i18n="label.time.ms"></option>
            <option value="seconds" data-i18n="label.time.s"></option>
            <option value="minutes" data-i18n="label.time.m"></option>
            <option value="hours" data-i18n="label.time.h"></option>
            <option value="days" data-i18n="label.time.d"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-sTimeout"><i class="fa fa-hourglass-end"></i> <span data-i18n="label.sTimeout"></span></label>
        <label style="vertical-align:middle;white-space:nowrap">
        <input type="text" id="node-input-sTimeout" style="text-align:end; width:50px !important">
        <select id="node-input-sTimeoutUnit" style="width:170px !important">
            <option value="milliseconds" data-i18n="label.time.ms"></option>
            <option value="seconds" data-i18n="label.time.s"></option>
            <option value="minutes" data-i18n="label.time.m"></option>
            <option value="hours" data-i18n="label.time.h"></option>
            <option value="days" data-i18n="label.time.d"></option>
        </select>
        <br><span style="font-style:italic;color:red" data-i18n="label.timeoutExplain"></span>
        </label>
    </div>

    <div class="form-row">
        <label for="node-input-aTimeout"><i class="fa fa-hourglass-end"></i> <span data-i18n="label.aTimeout"></span></label>
        <label style="vertical-align:middle;white-space:nowrap">
        <input type="text" id="node-input-aTimeout" style="text-align:end; width:50px !important">
        <select id="node-input-aTimeoutUnit" style="width:170px !important">
            <option value="milliseconds" data-i18n="label.time.ms"></option>
            <option value="seconds" data-i18n="label.time.s"></option>
            <option value="minutes" data-i18n="label.time.m"></option>
            <option value="hours" data-i18n="label.time.h"></option>
            <option value="days" data-i18n="label.time.d"></option>
        </select>
        <br><span style="font-style:italic;color:red" data-i18n="label.timeoutExplain"></span>
        </label>
    </div>

    <div class="form-row">
        <label for="node-input-seperated"> &nbsp;</label>
        <input type="checkbox" id="node-input-seperated" style="display:inline-block; width:15px; vertical-align:baseline;" autocomplete="off">
        <span><i class="fa fa-random"></i> <span data-i18n="label.seperateOutputs"></span></span>
        <input type="hidden" id="node-input-outputs" value="1">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('multiSensor',{
        category: 'function',
        color: '#a66bcf',
        defaults: {
            name: {value:""},
            idType: {value:"str"},
            idField: {value:"topic", validate: RED.validators.typedInput("idType")},
            inputType: {value:"msg"},
            inputValue: {value:"payload", validate: RED.validators.typedInput("inputType")},
            activeType: {value:"bool"},
            activeValue: {value:true, validate: RED.validators.typedInput("activeType")},
            inactiveType: {value:"bool"},
            inactiveValue: {value:false, validate: RED.validators.typedInput("inactiveType")},
            activateDelay: {value: "0", required: true, validate: RED.validators.number()},
            activateDelayUnit: {value:"seconds"},
            inactivateDelay: {value: "30", required: true, validate: RED.validators.number()},
            inactivateDelayUnit: {value:"seconds"},
            sendOnActiveType: {value:"pay"},
            sendOnActive: {value:undefined, validate: RED.validators.typedInput("sendOnActiveType")},
            sendOnInactiveType: {value:"payl"},
            sendOnInactive: {value:undefined, validate: RED.validators.typedInput("sendOnInactiveType")},
            sendOnTimeoutType: {value:"pay"},
            sendOnTimeout: {value:undefined, validate: RED.validators.typedInput("sendOnTimeoutType")},
            aTimeout: {value: "0", required: true, validate: function(v) { return v==undefined || RED.validators.number();} },
            aTimeoutUnit: {value:"minutes"},
            sTimeout: {value: "0", required: true, validate: function(v) { return v==undefined || RED.validators.number();} },
            sTimeoutUnit: {value:"minutes"},
            seperated: {value:false},
            outputs: {value:2}
        },
        inputs:1,
        outputs:1,
        outputLabels: function(index) {
            var o = this.outputs == 3;
            switch (index) {
                case 0: return o ? this._("channel.active") : this._("channel.output");
                case 1: return o ? this._("channel.inactive") : this._("channel.status");
                case 2: return this._("channel.status");
            }
        },
        icon: "trigger.png",
        label: function() {
            return this.name||this._("name");
        },

        oneditprepare: function() {
            var outputCount = $("#node-input-outputs").val("{}");

            var optionNothing = {value:"nul",label:this._("opt.nul"),hasValue:false};
            var optionOriginalMsg = {value:"pay",label:this._("opt.pay"),hasValue:false};
            var optionLatestMsg = {value:"payl",label:this._("opt.payl"),hasValue:false};
            
            $("#node-input-idField").typedInput({
                type:"msg",
                types:["msg","flow","global"],
                typeField: "#node-input-idType"
            });
            $("#node-input-inputValue").typedInput({
                type:"msg",
                types:["msg","flow","global","env"],
                typeField: "#node-input-inputType"
            });
            $("#node-input-activeValue").typedInput({
                type:"bool",
                types:["msg","flow","global","str","num","bool","re","env"],
                 typeField: "#node-input-activeType"
            });
            $("#node-input-inactiveValue").typedInput({
                type:"bool",
                types:["msg","flow","global","str","num","bool","re","env"],
                typeField: "#node-input-inactiveType"
            });
            
            $("#node-input-activateDelay").spinner({min: 0});
            $("#node-input-inactivateDelay").spinner({min: 0});

            $("#node-input-sendOnActive").typedInput({
                types:['msg','flow','global','str','num','bool',"jsonata",'json','bin','date','env',
                    optionOriginalMsg,
                    optionNothing
                ],
                typeField: "#node-input-sendOnActiveType"
            });

            $("#node-input-sendOnInactive").typedInput({
                types:['msg','flow','global','str','num','bool',"jsonata",'json','bin','date','env',
                    optionOriginalMsg,
                    optionLatestMsg,
                    optionNothing
                ],
                typeField: "#node-input-sendOnInactiveType"
            });

            $("#node-input-sendOnTimeout").typedInput({
                types:['msg','flow','global','str','num','bool',"jsonata",'json','bin','date','env',
                    optionOriginalMsg,
                    optionLatestMsg,
                    optionNothing
                ],
                typeField: "#node-input-sendOnTimeoutType"
            });

            var to = $("#node-input-sTimeout");
            to.spinner({min: 0});
            
            // If not set (updated), then update it
            if (to.val()=='') {
                to.val('0');
                $("#node-input-sTimeoutUnit").val('minutes');
            }
            
            var to = $("#node-input-aTimeout");
            to.spinner({min: 0});

            // If not set (updated), then update it
            if (to.val()=='') {
                to.val('0');
                $("#node-input-aTimeoutUnit").val('minutes');
            }

            var sepValue = this.outputs == 3;
            $("#node-input-seperated").prop('checked', (this.outputs == 3));
            $("#node-input-seperated").change(function() {
                var s = $("#node-input-seperated").is(":checked");
                var same = s == sepValue;
                var currentOutputs = JSON.parse(outputCount.val()||"{}");
                
                currentOutputs[0] = 0;
                if (s) {
                    currentOutputs[1] = same ? 1 : 2;
                    currentOutputs[2] = same ? 2 : 1;
                } else {
                    delete currentOutputs[1];
                    currentOutputs[2] = 1;
                }
                
                outputCount.val(JSON.stringify(currentOutputs));
            });
        },
        oneditsave: function() {
        }
    });
</script>
